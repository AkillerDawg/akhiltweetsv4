// Generated by CoffeeScript 1.7.1
var addTweet, addTweets, antarctica, antarcticaCounter, geocode, geocodeCache, geocodeNew, geocoder, infoWindow, lastTweetId, makeMarker, map, poll, renderTweet, _poll;

map = null;

geocoder = null;

infoWindow = null;

geocodeNew = function(address, cb) {
  return geocoder.geocode({
    address: address
  }, function(results, status) {
    if (status === google.maps.GeocoderStatus.OK) {
      if (status !== google.maps.GeocoderStatus.ZERO_RESULTS) {
        return cb(results[0].geometry.location);
      }
    }
    return cb(null);
  });
};

geocodeCache = {};

geocode = function(address, cb) {
  if (address in geocodeCache) {
    return cb(geocodeCache[address]);
  } else {
    return geocodeNew(address, function(loc) {
      if (loc) {
        geocodeCache[address] = loc;
      }
      return cb(loc);
    });
  }
};

renderTweet = function(tweet) {
  var url;
  url = "http://twitter.com/statuses/" + tweet.id;
  return "<a target='_blank' href='" + url + "'>" + tweet.text + "</a>";
};

makeMarker = function(map, loc, tweet) {
  var marker;
  marker = new google.maps.Marker({
    map: map,
    position: loc,
    title: tweet.place || "No Man's Land"
  });
  return marker.addListener('click', function() {
    if (infoWindow) {
      infoWindow.close();
    }
    infoWindow = new google.maps.InfoWindow({
      content: renderTweet(tweet)
    });
    return infoWindow.open(map, marker);
  });
};

antarcticaCounter = 0;

antarctica = function() {
  return {
    lat: -80,
    lng: antarcticaCounter++ * 7
  };
};

addTweet = function(tweet) {
  if (tweet.place) {
    return geocode(tweet.place, function(loc) {
      return makeMarker(map, loc, tweet);
    });
  } else {
    return makeMarker(map, antarctica(), tweet);
  }
};

lastTweetId = null;

addTweets = function(tweets) {
  var t, _i, _len, _results;
  if (tweets && tweets.length > 0) {
    lastTweetId = tweets[0].id;
    _results = [];
    for (_i = 0, _len = tweets.length; _i < _len; _i++) {
      t = tweets[_i];
      _results.push(addTweet(t));
    }
    return _results;
  }
};

_poll = function() {
  return $.getJSON('/poll', {
    username: window.username,
    sinceId: lastTweetId
  }, function(d) {
    addTweets(d.tweets);
    return poll();
  });
};

poll = function() {
  return setTimeout(_poll, 5000);
};

window.init = function() {
  map = new google.maps.Map($('#map')[0], {
    zoom: 2,
    center: {
      lat: -25.363,
      lng: 131.044
    }
  });
  geocoder = new google.maps.Geocoder();
  addTweets(window.tweets);
  return poll();
};
